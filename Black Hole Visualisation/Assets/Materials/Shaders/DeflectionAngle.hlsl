//UNITY_SHADER_NO_UPGRADE
#ifndef DEFLECTIONANGLE_INCLUDED
#define DEFLECTIONANGLE_INCLUDED

static float bs[100] = { 5.1962    ,    5.21808158,    5.24014824,    5.26240232,
                         5.28484623,    5.3074824 ,    5.33031332,    5.3533415 ,
                         5.37656953,    5.4       ,    5.4       ,    5.46102853,
                         5.52345226,    5.5873196 ,    5.6526812 ,    5.71959013,
                         5.78810199,    5.85827509,    5.93017058,    6.00385266,
                         6.07938877,    6.15684978,    6.23631022,    6.31784851,
                         6.40154724,    6.48749342,    6.5757788 ,    6.66650021,
                         6.75975988,    6.85566584,    6.95433235,    7.05588034,
                         7.16043791,    7.26814086,    7.3791333 ,    7.49356825,
                         7.61160842,    7.73342688,    7.859208  ,    7.98914832,
                         8.12345762,    8.26236002,    8.40609521,    8.55491988,
                         8.70910923,    8.86895864,    9.03478562,    9.20693183,
                         9.38576551,    9.57168407,    9.76511704,    9.96652938,
                        10.17642525,   10.39535216,   10.62390578,   10.86273535,
                        11.11254983,   11.37412493,   11.64831116,   11.93604308,
                        12.23834989,   12.5563678 ,   12.89135426,   13.2447046 ,
                        13.61797142,   14.01288742,   14.43139233,   14.8756647 ,
                        15.34815988,   15.85165542,   16.38930569,   16.96470804,
                        17.58198341,   18.24587513,   18.96187109,   19.7363558 ,
                        20.57680122,   21.49200869,   22.49241829,   23.59050882,
                        24.80132109,   26.14315089,   27.63847994,   29.31524564,
                        31.20860282,   33.36341548,   35.83785719,   38.70874209,
                        42.07964137,   46.0936451 ,   50.95419847,   56.96067509,
                        64.57247273,   74.53242765,   88.12527505,  107.7820139 ,
                       138.7253204 ,  194.59065511,  325.78633406, 1000.0 };

static float delta_phi[100] = { 11.20088385, 5.07909090, 4.39268254, 3.99264239,
                                 3.70982712, 3.49120112, 3.31314280, 3.16305518,
                                 3.03342178, 2.91939634, 2.91939634, 2.67780187,
                                 2.48602476, 2.32726575, 2.19199301, 2.07427622,
                                 1.97017480, 1.87693745, 1.79256754, 1.71557040,
                                 1.64479824, 1.57935064, 1.51850833, 1.46168771,
                                 1.40840881, 1.35827219, 1.31094190, 1.26613273,
                                 1.22360052, 1.18313464, 1.14455217, 1.10769321,
                                 1.07241723, 1.03860005, 1.00613140, 0.97491294,
                                 0.94485661, 0.91588321, 0.88792131, 0.86090624,
                                 0.83477925, 0.80948685, 0.78498019, 0.76121451,
                                 0.73814873, 0.71574508, 0.69396869, 0.67278735,
                                 0.65217125, 0.63209273, 0.61252607, 0.59344734,
                                 0.57483422, 0.55666588, 0.53892282, 0.52158678,
                                 0.50464065, 0.48806833, 0.47185471, 0.45598556,
                                 0.44044745, 0.42522772, 0.41031441, 0.39569622,
                                 0.38136244, 0.36730292, 0.35350806, 0.33996872,
                                 0.32667622, 0.31362233, 0.30079920, 0.28819935,
                                 0.27581566, 0.26364135, 0.25166993, 0.23989520,
                                 0.22831126, 0.21691244, 0.20569332, 0.19464873,
                                 0.18377369, 0.17306345, 0.16251342, 0.15211923,
                                 0.14187667, 0.13178169, 0.12183040, 0.11201907,
                                 0.10234408, 0.09280199, 0.08338945, 0.07410325,
                                 0.06494028, 0.05589756, 0.04697222, 0.03816145,
                                 0.02946258, 0.02087301, 0.01239023, 0.0 }; // 0.00401182

void DeflectionAngle_float(float b, float M, out float deflectionAngle, out float mask)
{
    if (b/M <= bs[0])
    {
        deflectionAngle = -1;
        mask = 0;
    }

    else
    {
        mask = 1;
        
        if (b/M >= bs[99])
            deflectionAngle = 0;
        else
        {
            // sqrt(27) ~= 5.2 -> The ray fell into the black hole

            int i = 0;
            while (bs[i + 1] < b/M && i < 98)
            {
                i++;
            }
        
            // b/R is between bs[i] and bs[i+1]
            // Interpolate between value delta_phi[i] and delta_phi[i+1]
            // f is interpolation factor between delta_phi[i] and delta_phi[i+1]

            float f = (b/M - bs[i]) / (bs[i+1] - bs[i]);

            // return (f-1) * y[i] + f * y[i+1]

            deflectionAngle = (1-f) * delta_phi[i] + f * delta_phi[i+1];
        }
    }
}

#endif //DEFLECTIONANGLE_INCLUDED